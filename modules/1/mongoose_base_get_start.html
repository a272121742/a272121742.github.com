<!DOCTYPE html>
<html>
  <head>

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, minimum-scale=1, maximum-scale=1" />

    <title>技术支持GitHub空间</title>
    <link rel="stylesheet" href="../../libs/jqm/jquery.mobile.min.css" />
    <link rel="stylesheet" href="../../libs/highlight/styles/monokai.css" >
    <link rel="stylesheet" href="../../stylesheets/style.css" >

    <script src="../../libs/jquery/jquery.min.js"></script>
    <script src="../../libs/jqm/jquery.mobile.min.js"></script>
    <script type="text/javascript">
    </script>
  </head>
  <body>
    <div data-role="page" data-theme="a">
      
      <div data-role="header" data-position="fixed">
        <a href="../../index.html" data-icon="home">主页</a>
        <h1>κiξs技ポ支歭\(≧▽≦)/</h1>
      </div>

      <div data-role="content">

<h2 id="mongoose">Mongoose学习参考文档</h2>

<p><strong>前言</strong>：本学习参考文档仅供参考，如有问题，师请雅正</p>

<h2 id="">一、快速通道</h2>

<h3 id="11">1.1 名词解释</h3>

<ul>
<li><p><code class="mdCode">Schema</code>  ：  一种以文件形式存储的数据库模型骨架，不具备数据库的操作能力</p></li>
<li><p><code class="mdCode">Model</code>   ：  由<code class="mdCode">Schema</code>发布生成的模型，具有抽象属性和行为的数据库操作对</p></li>
<li><p><code class="mdCode">Entity</code>  ：  由<code class="mdCode">Model</code>创建的实体，他的操作也会影响数据库</p></li>
</ul>

<p><strong>注意</strong>：</p>

<p>1.本学习文档采用严格命名方式来区别不同对象，例如：</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div><div class="line number3 index2 alt2" style="height: 18px;">3</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">var</code> <code class="js plain">PersonSchema;&nbsp;&nbsp; </code><code class="js comments">//Person的文本属性</code></div><div class="line number2 index1 alt1"><code class="js keyword">var</code> <code class="js plain">PersonModel;&nbsp;&nbsp;&nbsp; </code><code class="js comments">//Person的数据库模型</code></div><div class="line number3 index2 alt2"><code class="js keyword">var</code> <code class="js plain">PersonEntity;&nbsp;&nbsp; </code><code class="js comments">//Person实体</code></div></div></td></tr></tbody></table></div>
</div>

<p>2.<code class="mdCode">Schema</code>、<code class="mdCode">Model</code>、<code class="mdCode">Entity</code>的关系请牢记，<code class="mdCode">Schema</code>生成<code class="mdCode">Model</code>，<code class="mdCode">Model</code>创造<code class="mdCode">Entity</code>，<code class="mdCode">Model</code>和<code class="mdCode">Entity</code>都可对数据库操作造成影响，但<code class="mdCode">Model</code>比<code class="mdCode">Entity</code>更具操作性。</p>

<h2 id="12">1.2 准备工作</h2>

<p>1.首先你必须安装<a href="http://www.mongodb.org/">MongoDB</a>和<a href="http://nodejs.org/">NodeJS</a></p>

<p>2.在项目只能够创建一个数据库连接，如下:</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">var</code> <code class="js plain">mongoose = require(</code><code class="js string">'mongoose'</code><code class="js plain">);&nbsp;&nbsp;&nbsp; </code><code class="js comments">//引用mongoose模块</code></div><div class="line number2 index1 alt1"><code class="js keyword">var</code> <code class="js plain">db = mongoose.createConnection(</code><code class="js string">'localhost'</code><code class="js plain">,</code><code class="js string">'test'</code><code class="js plain">); </code><code class="js comments">//创建一个数据库连接</code></div></div></td></tr></tbody></table></div>
</div>

<p>3.打开本机<code class="mdCode">localhost</code>的<code class="mdCode">test</code>数据库时，我们可以监测是否有异常</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div><div class="line number3 index2 alt2" style="height: 18px;">3</div><div class="line number4 index3 alt1" style="height: 18px;">4</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js plain">db.on(</code><code class="js string">'error'</code><code class="js plain">,console.error.bind(console,</code><code class="js string">'连接错误:'</code><code class="js plain">));</code></div><div class="line number2 index1 alt1"><code class="js plain">db.once(</code><code class="js string">'open'</code><code class="js plain">,</code><code class="js keyword">function</code><code class="js plain">(){</code></div><div class="line number3 index2 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//一次打开记录</code></div><div class="line number4 index3 alt1"><code class="js plain">});</code></div></div></td></tr></tbody></table></div>
</div>

<p><strong>注意</strong>：</p>

<p>　　成功开启数据库后，就可以执行数据库相应操作，假设以下代码都在回调中处理</p>

<p>4.定义一个<code class="mdCode">Schema</code></p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div><div class="line number3 index2 alt2" style="height: 18px;">3</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">var</code> <code class="js plain">PersonSchema = </code><code class="js keyword">new</code> <code class="js plain">mongoose.Schema({</code></div><div class="line number2 index1 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">name:String&nbsp;&nbsp; </code><code class="js comments">//定义一个属性name，类型为String</code></div><div class="line number3 index2 alt2"><code class="js plain">});</code></div></div></td></tr></tbody></table></div>
</div>

<p>5.将该<code class="mdCode">Schema</code>发布为<code class="mdCode">Model</code></p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div><div class="line number3 index2 alt2" style="height: 18px;">3</div><div class="line number4 index3 alt1" style="height: 18px;">4</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">var</code> <code class="js plain">PersonModel = db.model(</code><code class="js string">'Person'</code><code class="js plain">,PersonSchema);</code></div><div class="line number2 index1 alt1"><code class="js comments">//如果该Model已经发布，则可以直接通过名字索引到，如下：</code></div><div class="line number3 index2 alt2"><code class="js comments">//var PersonModel = db.model('Person');</code></div><div class="line number4 index3 alt1"><code class="js comments">//如果没有发布，上一段代码将会异常</code></div></div></td></tr></tbody></table></div>
</div>

<p>6.用<code class="mdCode">Model</code>创建<code class="mdCode">Entity</code></p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div><div class="line number3 index2 alt2" style="height: 18px;">3</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">var</code> <code class="js plain">personEntity = </code><code class="js keyword">new</code> <code class="js plain">PersonModel({name:</code><code class="js string">'Krouky'</code><code class="js plain">});</code></div><div class="line number2 index1 alt1"><code class="js comments">//打印这个实体的名字看看</code></div><div class="line number3 index2 alt2"><code class="js plain">console.log(personEntity.name); </code><code class="js comments">//Krouky</code></div></div></td></tr></tbody></table></div>
</div>

<p>7.我们甚至可以为此<code class="mdCode">Schema</code>创建方法</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div><div class="line number3 index2 alt2" style="height: 18px;">3</div><div class="line number4 index3 alt1" style="height: 18px;">4</div><div class="line number5 index4 alt2" style="height: 18px;">5</div><div class="line number6 index5 alt1" style="height: 18px;">6</div><div class="line number7 index6 alt2" style="height: 18px;">7</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js comments">//为Schema模型追加speak方法</code></div><div class="line number2 index1 alt1"><code class="js plain">PersonSchema.methos.speak = </code><code class="js keyword">function</code><code class="js plain">(){</code></div><div class="line number3 index2 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">console.log(</code><code class="js string">'我的名字叫'</code><code class="js plain">+</code><code class="js keyword">this</code><code class="js plain">.name);</code></div><div class="line number4 index3 alt1"><code class="js plain">}</code></div><div class="line number5 index4 alt2"><code class="js keyword">var</code> <code class="js plain">PersonModel = db.model(</code><code class="js string">'Person'</code><code class="js plain">,PersonSchema);</code></div><div class="line number6 index5 alt1"><code class="js keyword">var</code> <code class="js plain">personEntity = </code><code class="js keyword">new</code> <code class="js plain">PersonModel({name:</code><code class="js string">'Krouky'</code><code class="js plain">});</code></div><div class="line number7 index6 alt2"><code class="js plain">personEntity.speak();</code><code class="js comments">//我的名字叫Krouky</code></div></div></td></tr></tbody></table></div>
</div>

<p>8.<code class="mdCode">Entity</code>是具有具体的数据库操作<code class="mdCode">CRUD</code>的</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js plain">personEntity.save();&nbsp; </code><code class="js comments">//执行完成后，数据库就有该数据了</code></div></div></td></tr></tbody></table></div>
</div>

<p>9.如果要执行查询，需要依赖<code class="mdCode">Model</code>，当然<code class="mdCode">Entity</code>也是可以做到的</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div><div class="line number3 index2 alt2" style="height: 18px;">3</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js plain">PersonModel.find(</code><code class="js keyword">function</code><code class="js plain">(err,persons){</code></div><div class="line number2 index1 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//查询到的所有person</code></div><div class="line number3 index2 alt2"><code class="js plain">})</code></div></div></td></tr></tbody></table></div>
</div>

<p><strong>注意</strong>：</p>

<p>　　1. 具体的如何配置<code class="mdCode">Schema</code>、<code class="mdCode">Model</code>以及<code class="mdCode">Model</code>和<code class="mdCode">Entity</code>的相关操作，我们会在后面进行</p>

<p>　　2. <code class="mdCode">Model</code>和<code class="mdCode">Entity</code>都有能影响数据库的操作，但仍有区别，后面我们也会做解释</p>

<h2 id="">二、新手指引</h2>

<p>　　<em>如果您还不清楚<code class="mdCode">Mongoose</code>是如何工作的，请参看第一章快速通道快速浏览他的用法吧</em></p>

<h3 id="1schema">1. Schema——纯洁的数据库原型</h3>

<h4 id="11schema">1.1 什么是Schema</h4>

<ul>
<li>我理解<code class="mdCode">Schema</code>仅仅只是一断代码，他书写完成后程序依然无法使用，更无法通往数据库端</li>
<li>他仅仅只是数据库模型在程序片段中的一种表现，或者是数据属性模型</li>
</ul>

<h4 id="12schema">1.2 如何定义Schema</h4>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div><div class="line number3 index2 alt2" style="height: 18px;">3</div><div class="line number4 index3 alt1" style="height: 18px;">4</div><div class="line number5 index4 alt2" style="height: 18px;">5</div><div class="line number6 index5 alt1" style="height: 18px;">6</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">var</code> <code class="js plain">BlogSchema = </code><code class="js keyword">new</code> <code class="js plain">Schema({</code></div><div class="line number2 index1 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">title:String,</code></div><div class="line number3 index2 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">author:String</code></div><div class="line number4 index3 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//new Schema()中传入一个JSON对象，该对象形如 xxx:yyyy ,</code></div><div class="line number5 index4 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">/xxx是一个字符串，定义了属性，yyy是一个Schema.Type，定义了属性类型</code></div><div class="line number6 index5 alt1"><code class="js plain">});</code></div></div></td></tr></tbody></table></div>
</div>

<h4 id="13schematype">1.3 什么是Schema.Type</h4>

<p>　　<code class="mdCode">Schema.Type</code>是由<code class="mdCode">Mongoose</code>内定的一些数据类型，基本数据类型都在其中，他也内置了一些<code class="mdCode">Mongoose</code>特有的<code class="mdCode">Schema.Type</code>。当然，你也可以自定义<code class="mdCode">Schema.Type</code>，只有满足<code class="mdCode">Schema.Type</code>的类型才能定义在<code class="mdCode">Schema</code>内。</p>

<h4 id="14schematypes">1.4 Schema.Types</h4>

<p>　　<code class="mdCode">NodeJS</code>中的基本数据类型都属于<code class="mdCode">Schema.Type</code>，另外<code class="mdCode">Mongoose</code>还定义了自己的类型</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div><div class="line number3 index2 alt2" style="height: 18px;">3</div><div class="line number4 index3 alt1" style="height: 18px;">4</div><div class="line number5 index4 alt2" style="height: 18px;">5</div><div class="line number6 index5 alt1" style="height: 18px;">6</div><div class="line number7 index6 alt2" style="height: 18px;">7</div><div class="line number8 index7 alt1" style="height: 18px;">8</div><div class="line number9 index8 alt2" style="height: 18px;">9</div><div class="line number10 index9 alt1" style="height: 18px;">10</div><div class="line number11 index10 alt2" style="height: 18px;">11</div><div class="line number12 index11 alt1" style="height: 18px;">12</div><div class="line number13 index12 alt2" style="height: 18px;">13</div><div class="line number14 index13 alt1" style="height: 18px;">14</div><div class="line number15 index14 alt2" style="height: 18px;">15</div><div class="line number16 index15 alt1" style="height: 18px;">16</div><div class="line number17 index16 alt2" style="height: 18px;">17</div><div class="line number18 index17 alt1" style="height: 18px;">18</div><div class="line number19 index18 alt2" style="height: 18px;">19</div><div class="line number20 index19 alt1" style="height: 18px;">20</div><div class="line number21 index20 alt2" style="height: 18px;">21</div><div class="line number22 index21 alt1" style="height: 18px;">22</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js comments">//举例：</code></div><div class="line number2 index1 alt1"><code class="js keyword">var</code> <code class="js plain">ExampleSchema = </code><code class="js keyword">new</code> <code class="js plain">Schema({</code></div><div class="line number3 index2 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">name:String,</code></div><div class="line number4 index3 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">binary:Buffer,</code></div><div class="line number5 index4 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">living:Boolean,</code></div><div class="line number6 index5 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">updated:Date,</code></div><div class="line number7 index6 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">age:Number,</code></div><div class="line number8 index7 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">mixed:Schema.Types.Mixed, </code><code class="js comments">//该混合类型等同于nested</code></div><div class="line number9 index8 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">_id:Schema.Types.ObjectId,&nbsp; </code><code class="js comments">//主键</code></div><div class="line number10 index9 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">_fk:Schema.Types.ObjectId,&nbsp; </code><code class="js comments">//外键</code></div><div class="line number11 index10 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">array:[],</code></div><div class="line number12 index11 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">arrOfString:[String],</code></div><div class="line number13 index12 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">arrOfNumber:[Number],</code></div><div class="line number14 index13 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">arrOfDate:[Date],</code></div><div class="line number15 index14 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">arrOfBuffer:[Buffer],</code></div><div class="line number16 index15 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">arrOfBoolean:[Boolean],</code></div><div class="line number17 index16 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">arrOfMixed:[Schema.Types.Mixed],</code></div><div class="line number18 index17 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">arrOfObjectId:[Schema.Types.ObjectId]</code></div><div class="line number19 index18 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">nested:{</code></div><div class="line number20 index19 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">stuff:String,</code></div><div class="line number21 index20 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">}</code></div><div class="line number22 index21 alt1"><code class="js plain">});</code></div></div></td></tr></tbody></table></div>
</div>

<h4 id="15buffer">1.5 关于Buffer</h4>

<p>　　<code class="mdCode">Buffer</code>和<code class="mdCode">ArrayBuffer</code>是<code class="mdCode">Nodejs</code>两种隐藏的对象，相关内容请查看<code class="mdCode">NodeJS-API</code></p>

<h4 id="16mixed">1.6 关于Mixed</h4>

<p>　　<code class="mdCode">Schema.Types.Mixed</code>是<code class="mdCode">Mongoose</code>定义个混合类型，该混合类型如果未定义具体形式。因此,如果定义具体内容，就直接使用<code class="mdCode">{}</code>来定义，以下两句等价</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">var</code> <code class="js plain">AnySchema = </code><code class="js keyword">new</code> <code class="js plain">Schema({any:{}});</code></div><div class="line number2 index1 alt1"><code class="js keyword">var</code> <code class="js plain">AnySchema = </code><code class="js keyword">new</code> <code class="js plain">Schema({any:Schema.Types.Mixed});</code></div></div></td></tr></tbody></table></div>
</div>

<p>　　混合类型因为没有特定约束，因此可以任意修改，一旦修改了原型，则必须调用<code class="mdCode">markModified()</code></p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div><div class="line number3 index2 alt2" style="height: 18px;">3</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js plain">person.anything = {x:[3,4,{y:</code><code class="js string">'change'</code><code class="js plain">}]}</code></div><div class="line number2 index1 alt1"><code class="js plain">person.markModified(</code><code class="js string">'anything'</code><code class="js plain">);</code><code class="js comments">//传入anything，表示该属性类型发生变化</code></div><div class="line number3 index2 alt2"><code class="js plain">person.save();</code></div></div></td></tr></tbody></table></div>
</div>

<h4 id="17objectid">1.7 关于ObjectId</h4>

<p>　　主键，一种特殊而且非常重要的类型，每个<code class="mdCode">Schema</code>都会默认配置这个属性，属性名为<code class="mdCode">_id</code>，除非自己定义，方可覆盖</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div><div class="line number3 index2 alt2" style="height: 18px;">3</div><div class="line number4 index3 alt1" style="height: 18px;">4</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">var</code> <code class="js plain">mongoose = require(</code><code class="js string">'mongoose'</code><code class="js plain">);</code></div><div class="line number2 index1 alt1"><code class="js keyword">var</code> <code class="js plain">ObjectId = mongoose.Schema.Types.ObjectId;</code></div><div class="line number3 index2 alt2"><code class="js keyword">var</code> <code class="js plain">StudentSchema = </code><code class="js keyword">new</code> <code class="js plain">Schema({}); </code><code class="js comments">//默认会有_id:ObjectId</code></div><div class="line number4 index3 alt1"><code class="js keyword">var</code> <code class="js plain">TeacherSchema = </code><code class="js keyword">new</code> <code class="js plain">Schema({id:ObjectId});</code><code class="js comments">//只有id:ObjectId</code></div></div></td></tr></tbody></table></div>
</div>

<p>　　该类型的值由系统自己生成，从某种意义上几乎不会重复，生成过程比较复杂，有兴趣的朋友可以查看源码。</p>

<h4 id="18array">1.8 关于Array</h4>

<p>　　<code class="mdCode">Array</code>在<code class="mdCode">JavaScript</code>编程语言中并不是数组，而是集合，因此里面可以存入不同的值，以下代码等价：</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div><div class="line number3 index2 alt2" style="height: 18px;">3</div><div class="line number4 index3 alt1" style="height: 18px;">4</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">var</code> <code class="js plain">ExampleSchema1 = </code><code class="js keyword">new</code> <code class="js plain">Schema({array:[]});</code></div><div class="line number2 index1 alt1"><code class="js keyword">var</code> <code class="js plain">ExampleSchema2 = </code><code class="js keyword">new</code> <code class="js plain">Schema({array:Array});</code></div><div class="line number3 index2 alt2"><code class="js keyword">var</code> <code class="js plain">ExampleSchema3 = </code><code class="js keyword">new</code> <code class="js plain">Schema({array:[Schema.Types.Mixed]});</code></div><div class="line number4 index3 alt1"><code class="js keyword">var</code> <code class="js plain">ExampleSchema4 = </code><code class="js keyword">new</code> <code class="js plain">Schema({array:[{}]});</code></div></div></td></tr></tbody></table></div>
</div>

<h4 id="19">1.9 附言</h4>

<p>　　<code class="mdCode">Schema</code>不仅定义了<code class="mdCode">文档结构</code>和<code class="mdCode">使用性能</code>，还可以有<code class="mdCode">扩展插件</code>、<code class="mdCode">实例方法</code>、<code class="mdCode">静态方法</code>、<code class="mdCode">复合索引</code>、<code class="mdCode">文档生命周期钩子</code></p>

<p>　　<code class="mdCode">Schema</code>可以定义插件，并且插件具有良好的可拔插性，请有兴趣的读者继续往后阅读或者查阅官方资料。</p>

<h3 id="2schema">2. Schema的扩展</h3>

<h4 id="21">2.1 实例方法</h4>

<p>　　有的时候，我们创造的<code class="mdCode">Schema</code>不仅要为后面的<code class="mdCode">Model</code>和<code class="mdCode">Entity</code>提供公共的属性，还要提供公共的方法。</p>

<p>　　下面例子比快速通道的例子更加高级，可以进行高级扩展：</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div><div class="line number3 index2 alt2" style="height: 18px;">3</div><div class="line number4 index3 alt1" style="height: 18px;">4</div><div class="line number5 index4 alt2" style="height: 18px;">5</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">var</code> <code class="js plain">PersonSchema = </code><code class="js keyword">new</code> <code class="js plain">Schema({name:String,type:String});</code></div><div class="line number2 index1 alt1"><code class="js comments">//查询类似数据</code></div><div class="line number3 index2 alt2"><code class="js plain">PersonSchema.methods.findSimilarTypes = </code><code class="js keyword">function</code><code class="js plain">(cb){</code></div><div class="line number4 index3 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">return</code> <code class="js keyword">this</code><code class="js plain">.model(</code><code class="js string">'Person'</code><code class="js plain">).find({type:</code><code class="js keyword">this</code><code class="js plain">.type},cb);</code></div><div class="line number5 index4 alt2"><code class="js plain">}</code></div></div></td></tr></tbody></table></div>
</div>

<p>　　使用如下：</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div><div class="line number3 index2 alt2" style="height: 18px;">3</div><div class="line number4 index3 alt1" style="height: 18px;">4</div><div class="line number5 index4 alt2" style="height: 18px;">5</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">var</code> <code class="js plain">PersonModel = mongoose.model(</code><code class="js string">'Person'</code><code class="js plain">,PersonSchema);</code></div><div class="line number2 index1 alt1"><code class="js keyword">var</code> <code class="js plain">krouky = </code><code class="js keyword">new</code> <code class="js plain">PersonSchema({name:</code><code class="js string">'krouky'</code><code class="js plain">,type:</code><code class="js string">'前端工程师'</code><code class="js plain">});</code></div><div class="line number3 index2 alt2"><code class="js plain">krouky.findSimilarTypes(</code><code class="js keyword">function</code><code class="js plain">(err,persons){</code></div><div class="line number4 index3 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//persons中就能查询到其他前端工程师</code></div><div class="line number5 index4 alt2"><code class="js plain">});</code></div></div></td></tr></tbody></table></div>
</div>

<h4 id="22">2.2 静态方法</h4>

<p>　　静态方法在<code class="mdCode">Model</code>层就能使用，如下：</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div><div class="line number3 index2 alt2" style="height: 18px;">3</div><div class="line number4 index3 alt1" style="height: 18px;">4</div><div class="line number5 index4 alt2" style="height: 18px;">5</div><div class="line number6 index5 alt1" style="height: 18px;">6</div><div class="line number7 index6 alt2" style="height: 18px;">7</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js plain">PersonSchema.statics.findByName = </code><code class="js keyword">function</code><code class="js plain">(name,cb){</code></div><div class="line number2 index1 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">this</code><code class="js plain">.find({name:</code><code class="js keyword">new</code> <code class="js plain">RegExp(name,</code><code class="js string">'i'</code><code class="js plain">),cb});</code></div><div class="line number3 index2 alt2"><code class="js plain">}</code></div><div class="line number4 index3 alt1"><code class="js keyword">var</code> <code class="js plain">PersonModel = mongoose.model(</code><code class="js string">'Person'</code><code class="js plain">,PersonSchema);</code></div><div class="line number5 index4 alt2"><code class="js plain">PersonModel.findByName(</code><code class="js string">'krouky'</code><code class="js plain">,</code><code class="js keyword">function</code><code class="js plain">(err,persons){</code></div><div class="line number6 index5 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//找到所有名字叫krouky的人</code></div><div class="line number7 index6 alt2"><code class="js plain">});</code></div></div></td></tr></tbody></table></div>
</div>

<h4 id="23">2.3 索引</h4>

<p>　　索引或者复合索引能让搜索更加高效，默认索引就是主键索引<code class="mdCode">ObjectId</code>，属性名为<code class="mdCode">_id</code>， <em>索引会作为一个专题来讲解</em></p>

<h4 id="24">2.4 虚拟属性</h4>

<p>　　<code class="mdCode">Schema</code>中如果定义了虚拟属性，那么该属性将不写入数据库，例如：</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div><div class="line number3 index2 alt2" style="height: 18px;">3</div><div class="line number4 index3 alt1" style="height: 18px;">4</div><div class="line number5 index4 alt2" style="height: 18px;">5</div><div class="line number6 index5 alt1" style="height: 18px;">6</div><div class="line number7 index6 alt2" style="height: 18px;">7</div><div class="line number8 index7 alt1" style="height: 18px;">8</div><div class="line number9 index8 alt2" style="height: 18px;">9</div><div class="line number10 index9 alt1" style="height: 18px;">10</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">var</code> <code class="js plain">PersonSchema = </code><code class="js keyword">new</code> <code class="js plain">Schema({</code></div><div class="line number2 index1 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">name:{</code></div><div class="line number3 index2 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">first:String,</code></div><div class="line number4 index3 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">last:String</code></div><div class="line number5 index4 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">}</code></div><div class="line number6 index5 alt1"><code class="js plain">});</code></div><div class="line number7 index6 alt2"><code class="js keyword">var</code> <code class="js plain">PersonModel = mongoose.model(</code><code class="js string">'Person'</code><code class="js plain">,PersonSchema);</code></div><div class="line number8 index7 alt1"><code class="js keyword">var</code> <code class="js plain">krouky = </code><code class="js keyword">new</code> <code class="js plain">PersonModel({</code></div><div class="line number9 index8 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">name:{first:</code><code class="js string">'krouky'</code><code class="js plain">,last:</code><code class="js string">'han'</code><code class="js plain">}</code></div><div class="line number10 index9 alt1"><code class="js plain">});</code></div></div></td></tr></tbody></table></div>
</div>

<p>　　如果每次想使用全名就得这样</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js plain">console.log(krouky.name.first + </code><code class="js string">' '</code> <code class="js plain">+ krouky.name.last);</code></div></div></td></tr></tbody></table></div>
</div>

<p>　　显然这是很麻烦的，我们可以定义<code class="mdCode">虚拟属性</code>：</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div><div class="line number3 index2 alt2" style="height: 18px;">3</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js plain">PersonSchema.virtual(</code><code class="js string">'name.full'</code><code class="js plain">).get(</code><code class="js keyword">function</code><code class="js plain">(){</code></div><div class="line number2 index1 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">return</code> <code class="js keyword">this</code><code class="js plain">.name.first + </code><code class="js string">' '</code> <code class="js plain">+ </code><code class="js keyword">this</code><code class="js plain">.name.last;</code></div><div class="line number3 index2 alt2"><code class="js plain">});</code></div></div></td></tr></tbody></table></div>
</div>

<p>　　那么就能用<code class="mdCode">krouky.name.full</code>来调用全名了，反之如果知道full，也可以反解<code class="mdCode">first</code>和<code class="mdCode">last</code>属性</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div><div class="line number3 index2 alt2" style="height: 18px;">3</div><div class="line number4 index3 alt1" style="height: 18px;">4</div><div class="line number5 index4 alt2" style="height: 18px;">5</div><div class="line number6 index5 alt1" style="height: 18px;">6</div><div class="line number7 index6 alt2" style="height: 18px;">7</div><div class="line number8 index7 alt1" style="height: 18px;">8</div><div class="line number9 index8 alt2" style="height: 18px;">9</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js plain">PersonSchema.virtual(</code><code class="js string">'name.full'</code><code class="js plain">).set(</code><code class="js keyword">function</code><code class="js plain">(name){</code></div><div class="line number2 index1 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">var</code> <code class="js plain">split = name.split(</code><code class="js string">' '</code><code class="js plain">);</code></div><div class="line number3 index2 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">this</code><code class="js plain">.name.first = split[0];</code></div><div class="line number4 index3 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">this</code><code class="js plain">.name.last = split[1];</code></div><div class="line number5 index4 alt2"><code class="js plain">});</code></div><div class="line number6 index5 alt1"><code class="js keyword">var</code> <code class="js plain">PersonModel = mongoose.model(</code><code class="js string">'Person'</code><code class="js plain">,PersonSchema);</code></div><div class="line number7 index6 alt2"><code class="js keyword">var</code> <code class="js plain">krouky = </code><code class="js keyword">new</code> <code class="js plain">PersonModel({});</code></div><div class="line number8 index7 alt1"><code class="js plain">krouky.name.full = </code><code class="js string">'krouky han'</code><code class="js plain">;</code><code class="js comments">//会被自动分解</code></div><div class="line number9 index8 alt2"><code class="js plain">console.log(krouky.name.first);</code><code class="js comments">//krouky</code></div></div></td></tr></tbody></table></div>
</div>

<h4 id="25">2.5 配置项</h4>

<p>　　在使用<code class="mdCode">new Schema(config)</code>时，我们可以追加一个参数<code class="mdCode">options</code>来配置<code class="mdCode">Schema</code>的配置，形如：</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">var</code> <code class="js plain">ExampleSchema = </code><code class="js keyword">new</code> <code class="js plain">Schema(config,options);</code></div></div></td></tr></tbody></table></div>
</div>

<p>　　或者使用</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div id="highlighter_569379" class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">var</code> <code class="js plain">ExampleSchema = </code><code class="js keyword">new</code> <code class="js plain">Schema(config);</code></div><div class="line number2 index1 alt1"><code class="js plain">ExampleSchema.set(option,value);</code></div></div></td></tr></tbody></table></div>
</div>

<p>　　可供配置项有：<code class="mdCode">safe</code>、<code class="mdCode">strict</code>、<code class="mdCode">capped</code>、<code class="mdCode">versionKey</code>、<code class="mdCode">autoIndex</code></p>

<h5 id="251safe">2.5.1 safe——安全属性（默认安全）</h5>

<p>　　一般可做如下配置：</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div id="highlighter_342739" class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">new</code> <code class="js plain">Schema({...},{safe:</code><code class="js keyword">true</code><code class="js plain">});</code></div></div></td></tr></tbody></table></div>
</div>

<p>　　当然我们也可以这样</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">new</code> <code class="js plain">Schema({...},{safe:{j:1,w:2,wtimeout:10000}});</code></div></div></td></tr></tbody></table></div>
</div>

<p>　　<code class="mdCode">j</code>表示做1份日志，<code class="mdCode">w</code>表示做2个副本（尚不明确），超时时间10秒</p>

<h5 id="252strict">2.5.2 strict——严格配置（默认启用）</h5>

<p>　　确保<code class="mdCode">Entity</code>的值存入数据库前会被自动验证，如果你没有充足的理由，请不要停用，例子：</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div><div class="line number3 index2 alt2" style="height: 18px;">3</div><div class="line number4 index3 alt1" style="height: 18px;">4</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">var</code> <code class="js plain">ThingSchema = </code><code class="js keyword">new</code> <code class="js plain">Schema({a:String});</code></div><div class="line number2 index1 alt1"><code class="js keyword">var</code> <code class="js plain">ThingModel = db.model(</code><code class="js string">'Thing'</code><code class="js plain">,SchemaSchema);</code></div><div class="line number3 index2 alt2"><code class="js keyword">var</code> <code class="js plain">thing = </code><code class="js keyword">new</code> <code class="js plain">Thing({iAmNotInTheThingSchema:</code><code class="js keyword">true</code><code class="js plain">});</code></div><div class="line number4 index3 alt1"><code class="js plain">thing.save();</code><code class="js comments">//iAmNotInTheThingSchema这个属性将无法被存储</code></div></div></td></tr></tbody></table></div>
</div>

<p>　　如果取消严格选项，<code class="mdCode">iAmNotInTheThingSchema</code>将会被存入数据库</p>

<p>　　该选项也可以在构造实例时使用，例如：</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div><div class="line number3 index2 alt2" style="height: 18px;">3</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">var</code> <code class="js plain">ThingModel = db.model(</code><code class="js string">'Thing'</code><code class="js plain">);</code></div><div class="line number2 index1 alt1"><code class="js keyword">var</code> <code class="js plain">thing1 = </code><code class="js keyword">new</code> <code class="js plain">ThingModel(doc,</code><code class="js keyword">true</code><code class="js plain">);&nbsp; </code><code class="js comments">//启用严格</code></div><div class="line number3 index2 alt2"><code class="js keyword">var</code> <code class="js plain">thing2 = </code><code class="js keyword">new</code> <code class="js plain">ThingModel(doc,</code><code class="js keyword">false</code><code class="js plain">); </code><code class="js comments">//禁用严格</code></div></div></td></tr></tbody></table></div>
</div>

<p><strong>注意：</strong></p>

<p>　　<code class="mdCode">strict</code>也可以设置为<code class="mdCode">throw</code>，表示出现问题将会抛出错误</p>

<h5 id="253shardkey">2.5.3 shardKey</h5>

<p>　　需要<code class="mdCode">mongodb</code>做分布式，才会使用该属性</p>

<h5 id="254capped">2.5.4 capped——上限设置</h5>

<p>　　如果有数据库的批量操作，该属性能限制一次操作的量，例如：</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">new</code> <code class="js plain">Schema({...},{capped:1024});&nbsp; </code><code class="js comments">//一次操作上线1024条数据</code></div></div></td></tr></tbody></table></div>
</div>

<p>　　当然该参数也可是JSON对象，包含size、max、autiIndexId属性</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">new</code> <code class="js plain">Schema({...},{capped:{size:1024,max:100,autoIndexId:</code><code class="js keyword">true</code><code class="js plain">}});</code></div></div></td></tr></tbody></table></div>
</div>

<h5 id="255versionkey">2.5.5 versionKey——版本锁</h5>

<p>　　版本锁是<code class="mdCode">Mongoose</code>默认配置（__v属性）的，如果你想自己定制，如下：</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">new</code> <code class="js plain">Schema({...},{versionKey:</code><code class="js string">'__someElse'</code><code class="js plain">});</code></div></div></td></tr></tbody></table></div>
</div>

<p>　　此时存入数据库的版本锁就不是<code class="mdCode">__v</code>属性，而是<code class="mdCode">__someElse</code>，相当于是给版本锁取名字。</p>

<p>　　具体怎么存入都是由<code class="mdCode">Mongoose</code>和<code class="mdCode">MongoDB</code>自己决定，当然，这个属性你也可以去除</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div id="highlighter_734089" class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">new</code> <code class="js plain">Schema({...},{versionKey:</code><code class="js keyword">false</code><code class="js plain">});</code></div></div></td></tr></tbody></table></div>
</div>

<p>　　除非你知道你在做什么，并且你知道这样做的后果</p>

<h5 id="256autoindex">2.5.6 autoIndex——自动索引</h5>

<p>　　<em>该内容将在索引章节单独讲解</em></p>

<h3 id="3documents">3. Documents</h3>

<p>　　<code class="mdCode">Document</code>是与<code class="mdCode">MongoDB</code>文档一一对应的模型，<code class="mdCode">Document</code>可等同于<code class="mdCode">Entity</code>，具有属性和操作性</p>

<p><strong>注意：</strong></p>

<p>　　<code class="mdCode">Document</code>的`CRUD都必须经过严格验证的，参看<strong>2.5.2 Schema的strict严格配置</strong></p>

<h4 id="31">3.1 查询</h4>

<p>　　查询内容过多，专题讲解</p>

<h4 id="32">3.2 更新</h4>

<p>　　有许多方式来更新文件，以下是常用的传统方式：</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div><div class="line number3 index2 alt2" style="height: 18px;">3</div><div class="line number4 index3 alt1" style="height: 18px;">4</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js plain">PersonModel.findById(id,</code><code class="js keyword">function</code><code class="js plain">(err,person){</code></div><div class="line number2 index1 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">person.name = </code><code class="js string">'MDragon'</code><code class="js plain">;</code></div><div class="line number3 index2 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">person.save(</code><code class="js keyword">function</code><code class="js plain">(err){});</code></div><div class="line number4 index3 alt1"><code class="js plain">});</code></div></div></td></tr></tbody></table></div>
</div>

<p>　　这里，利用<code class="mdCode">Model</code>模型查询到了<code class="mdCode">person</code>对象，该对象属于<code class="mdCode">Entity</code>，可以有<code class="mdCode">save操作，如果使用</code>Model`操作，需注意：</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div><div class="line number3 index2 alt2" style="height: 18px;">3</div><div class="line number4 index3 alt1" style="height: 18px;">4</div><div class="line number5 index4 alt2" style="height: 18px;">5</div><div class="line number6 index5 alt1" style="height: 18px;">6</div><div class="line number7 index6 alt2" style="height: 18px;">7</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js plain">PersonModel.findById(id,</code><code class="js keyword">function</code><code class="js plain">(err,person){</code></div><div class="line number2 index1 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">person.name = </code><code class="js string">'MDragon'</code><code class="js plain">;</code></div><div class="line number3 index2 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">var</code> <code class="js plain">_id = person._id; </code><code class="js comments">//需要取出主键_id</code></div><div class="line number4 index3 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">delete</code> <code class="js plain">person._id;&nbsp;&nbsp;&nbsp; </code><code class="js comments">//再将其删除</code></div><div class="line number5 index4 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">PersonModel.update({_id:_id},person,</code><code class="js keyword">function</code><code class="js plain">(err){});</code></div><div class="line number6 index5 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//此时才能用Model操作，否则报错</code></div><div class="line number7 index6 alt2"><code class="js plain">});</code></div></div></td></tr></tbody></table></div>
</div>

<p>　　<code class="mdCode">update</code>第一个参数是查询条件，第二个参数是更新的对象，但不能更新主键，这就是为什么要删除主键的原因。</p>

<p>　　当然这样的更新很麻烦，可以使用<code class="mdCode">$set</code>属性来配置，这样也不用先查询，如果更新的数据比较少，可用性还是很好的：</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div id="highlighter_988914" class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js plain">PersonModel.update({_id:_id},{$set:{name:</code><code class="js string">'MDragon'</code><code class="js plain">}},</code><code class="js keyword">function</code><code class="js plain">(err){});</code></div></div></td></tr></tbody></table></div>
</div>

<p>　　需要注意，<code class="mdCode">Document</code>的<code class="mdCode">CRUD</code>操作都是异步执行，<code class="mdCode">callback</code>第一个参数必须是<code class="mdCode">err</code>，而第二个参数各个方法不一样，<code class="mdCode">update</code>的<code class="mdCode">callback</code>第二个参数是更新的数量，如果要返回更新后的对象，则要使用如下方法</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div id="highlighter_741194" class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div><div class="line number3 index2 alt2" style="height: 18px;">3</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js plain">Person.findByIdAndUpdate(_id,{$set:{name:</code><code class="js string">'MDragon'</code><code class="js plain">}},</code><code class="js keyword">function</code><code class="js plain">(err,person){</code></div><div class="line number2 index1 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">console.log(person.name); </code><code class="js comments">//MDragon</code></div><div class="line number3 index2 alt2"><code class="js plain">});</code></div></div></td></tr></tbody></table></div>
</div>

<p>　　类似的方法还有<code class="mdCode">findByIdAndRemove</code>，如同名字，只能根据id查询并作<code class="mdCode">update</code>/<code class="mdCode">remove</code>操作，操作的数据仅一条</p>

<h4 id="33">3.3 新增</h4>

<p>　　如果是<code class="mdCode">Entity</code>，使用<code class="mdCode">save</code>方法，如果是<code class="mdCode">Model</code>，使用<code class="mdCode">create</code>方法</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div><div class="line number3 index2 alt2" style="height: 18px;">3</div><div class="line number4 index3 alt1" style="height: 18px;">4</div><div class="line number5 index4 alt2" style="height: 18px;">5</div><div class="line number6 index5 alt1" style="height: 18px;">6</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js comments">//使用Entity来增加一条数据</code></div><div class="line number2 index1 alt1"><code class="js keyword">var</code> <code class="js plain">krouky = </code><code class="js keyword">new</code> <code class="js plain">PersonModel({name:</code><code class="js string">'krouky'</code><code class="js plain">});</code></div><div class="line number3 index2 alt2"><code class="js plain">krouky.save(callback);</code></div><div class="line number4 index3 alt1"><code class="js comments">//使用Model来增加一条数据</code></div><div class="line number5 index4 alt2"><code class="js keyword">var</code> <code class="js plain">MDragon = {name:</code><code class="js string">'MDragon'</code><code class="js plain">};</code></div><div class="line number6 index5 alt1"><code class="js plain">PersonModel.create(MDragon,callback);</code></div></div></td></tr></tbody></table></div>
</div>

<p>　　两种新增方法区别在于，如果使用<code class="mdCode">Model</code>新增时，传入的对象只能是纯净的<code class="mdCode">JSON</code>对象，不能是由<code class="mdCode">Model</code>创建的实体，原因是：由<code class="mdCode">Model</code>创建的实体<code class="mdCode">krouky</code>虽然打印是只有<code class="mdCode">{name:'krouky'}</code>，但是<code class="mdCode">krouky</code>属于<code class="mdCode">Entity</code>，包含有<code class="mdCode">Schema</code>属性和<code class="mdCode">Model</code>数据库行为模型。如果是使用<code class="mdCode">Model</code>创建的对象，传入时一定会将隐藏属性也存入数据库，虽然<code class="mdCode">3.x</code>追加了默认严格属性，但也不必要增加操作的报错</p>

<h4 id="34">3.4 删除</h4>

<p>　　和新增一样，删除也有2种方式，但<code class="mdCode">Entity</code>和<code class="mdCode">Model</code>都使用<code class="mdCode">remove</code>方法</p>

<h3 id="4subdocs">4.Sub Docs</h3>

<p>　　如同<code class="mdCode">SQL</code>数据库中2张表有主外关系，<code class="mdCode">Mongoose</code>将2个<code class="mdCode">Document</code>的嵌套叫做<code class="mdCode">Sub-Docs</code>（子文档）</p>

<p>　　简单的说就是一个<code class="mdCode">Document</code>嵌套另外一个<code class="mdCode">Document</code>或者<code class="mdCode">Documents</code>:</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div><div class="line number3 index2 alt2" style="height: 18px;">3</div><div class="line number4 index3 alt1" style="height: 18px;">4</div><div class="line number5 index4 alt2" style="height: 18px;">5</div><div class="line number6 index5 alt1" style="height: 18px;">6</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">var</code> <code class="js plain">ChildSchema1 = </code><code class="js keyword">new</code> <code class="js plain">Schema({name:String});</code></div><div class="line number2 index1 alt1"><code class="js keyword">var</code> <code class="js plain">ChildSchema2 = </code><code class="js keyword">new</code> <code class="js plain">Schema({name:String});</code></div><div class="line number3 index2 alt2"><code class="js keyword">var</code> <code class="js plain">ParentSchema = </code><code class="js keyword">new</code> <code class="js plain">Schema({</code></div><div class="line number4 index3 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">children1:ChildSchema1,&nbsp;&nbsp; </code><code class="js comments">//嵌套Document</code></div><div class="line number5 index4 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">children2:[ChildSchema2]&nbsp; </code><code class="js comments">//嵌套Documents</code></div><div class="line number6 index5 alt1"><code class="js plain">});</code></div></div></td></tr></tbody></table></div>
</div>

<p>　　<code class="mdCode">Sub-Docs</code>享受和<code class="mdCode">Documents</code>一样的操作，但是<code class="mdCode">Sub-Docs</code>的操作都由父类去执行</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div><div class="line number3 index2 alt2" style="height: 18px;">3</div><div class="line number4 index3 alt1" style="height: 18px;">4</div><div class="line number5 index4 alt2" style="height: 18px;">5</div><div class="line number6 index5 alt1" style="height: 18px;">6</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">var</code> <code class="js plain">ParentModel = db.model(</code><code class="js string">'Parent'</code><code class="js plain">,parentSchema);</code></div><div class="line number2 index1 alt1"><code class="js keyword">var</code> <code class="js plain">parent = </code><code class="js keyword">new</code> <code class="js plain">ParentModel({</code></div><div class="line number3 index2 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">children2:[{name:</code><code class="js string">'c1'</code><code class="js plain">},{name:</code><code class="js string">'c2'</code><code class="js plain">}]</code></div><div class="line number4 index3 alt1"><code class="js plain">});</code></div><div class="line number5 index4 alt2"><code class="js plain">parent.children2[0].name = </code><code class="js string">'d'</code><code class="js plain">;</code></div><div class="line number6 index5 alt1"><code class="js plain">parent.save(callback);</code></div></div></td></tr></tbody></table></div>
</div>

<p>　　<code class="mdCode">parent</code>在执行保存时，由于包含<code class="mdCode">children2</code>，他是一个数据库模型对象，因此会先保存<code class="mdCode">chilren2[0]</code>和<code class="mdCode">chilren2[1]</code>。</p>

<p>　　如果子文档在更新时出现错误，将直接报在父类文档中，可以这样处理：</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div><div class="line number3 index2 alt2" style="height: 18px;">3</div><div class="line number4 index3 alt1" style="height: 18px;">4</div><div class="line number5 index4 alt2" style="height: 18px;">5</div><div class="line number6 index5 alt1" style="height: 18px;">6</div><div class="line number7 index6 alt2" style="height: 18px;">7</div><div class="line number8 index7 alt1" style="height: 18px;">8</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js plain">ChildrenSchema.pre(</code><code class="js string">'save'</code><code class="js plain">,</code><code class="js keyword">function</code><code class="js plain">(next){</code></div><div class="line number2 index1 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">if</code><code class="js plain">(</code><code class="js string">'x'</code> <code class="js plain">=== </code><code class="js keyword">this</code><code class="js plain">.name) </code><code class="js keyword">return</code> <code class="js plain">next(</code><code class="js keyword">new</code> <code class="js plain">Error(</code><code class="js string">'#err:not-x'</code><code class="js plain">));</code></div><div class="line number3 index2 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">next();</code></div><div class="line number4 index3 alt1"><code class="js plain">});</code></div><div class="line number5 index4 alt2"><code class="js keyword">var</code> <code class="js plain">parent = </code><code class="js keyword">new</code> <code class="js plain">ParentModel({children1:{name:</code><code class="js string">'not-x'</code><code class="js plain">}});</code></div><div class="line number6 index5 alt1"><code class="js plain">parent.save(</code><code class="js keyword">function</code><code class="js plain">(err){</code></div><div class="line number7 index6 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">console.log(err.message); </code><code class="js comments">//#err:not-x</code></div><div class="line number8 index7 alt1"><code class="js plain">});</code></div></div></td></tr></tbody></table></div>
</div>

<h4 id="41">4.1 查询子文档</h4>

<p>　　如果<code class="mdCode">children</code>是<code class="mdCode">parent</code>的子文档，可以通过如下方法查询到<code class="mdCode">children</code></p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div id="highlighter_493681" class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">var</code> <code class="js plain">child = parent.children.id(id);</code></div></div></td></tr></tbody></table></div>
</div>

<h4 id="42">4.2 新增、删除、更新</h4>

<p>　　子文档是父文档的一个属性，因此按照属性的操作即可，不同的是在新增父类的时候，子文档是会被先加入进去的。</p>

<p>　　如果<code class="mdCode">ChildrenSchema</code>是临时的一个子文档，不作为数据库映射集合，可以这样：</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div><div class="line number3 index2 alt2" style="height: 18px;">3</div><div class="line number4 index3 alt1" style="height: 18px;">4</div><div class="line number5 index4 alt2" style="height: 18px;">5</div><div class="line number6 index5 alt1" style="height: 18px;">6</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">var</code> <code class="js plain">ParentSchema = </code><code class="js keyword">new</code> <code class="js plain">Schema({</code></div><div class="line number2 index1 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">children:{</code></div><div class="line number3 index2 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">name:String</code></div><div class="line number4 index3 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">}</code></div><div class="line number5 index4 alt2"><code class="js plain">});</code></div><div class="line number6 index5 alt1"><code class="js comments">//其实就是匿名混合模式</code></div></div></td></tr></tbody></table></div>
</div>

<h3 id="5model">5.Model</h3>

<h4 id="51model">5.1 什么是Model</h4>

<p>　　<code class="mdCode">Model</code>模型，是经过<code class="mdCode">Schema</code>构造来的，除了<code class="mdCode">Schema</code>定义的数据库骨架以外，还具有数据库行为模型，他相当于管理数据库属性、行为的类</p>

<h4 id="52model">5.2 如何创建Model</h4>

<p>　　你必须通过<code class="mdCode">Schema</code>来创建，如下：</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div><div class="line number3 index2 alt2" style="height: 18px;">3</div><div class="line number4 index3 alt1" style="height: 18px;">4</div><div class="line number5 index4 alt2" style="height: 18px;">5</div><div class="line number6 index5 alt1" style="height: 18px;">6</div><div class="line number7 index6 alt2" style="height: 18px;">7</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js comments">//先创建Schema</code></div><div class="line number2 index1 alt1"><code class="js keyword">var</code> <code class="js plain">TankSchema = </code><code class="js keyword">new</code> <code class="js plain">Schema({</code></div><div class="line number3 index2 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">name:</code><code class="js string">'String'</code><code class="js plain">,</code></div><div class="line number4 index3 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">size:</code><code class="js string">'String'</code></div><div class="line number5 index4 alt2"><code class="js plain">});</code></div><div class="line number6 index5 alt1"><code class="js comments">//通过Schema创建Model</code></div><div class="line number7 index6 alt2"><code class="js keyword">var</code> <code class="js plain">TankModel = mongoose.model(</code><code class="js string">'Tank'</code><code class="js plain">,TankSchema);</code></div></div></td></tr></tbody></table></div>
</div>

<h4 id="52model">5.2 操作Model</h4>

<p>　　该模型就能直接拿来操作，具体查看<code class="mdCode">API</code>，例如：</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">var</code> <code class="js plain">tank = {</code><code class="js string">'something'</code><code class="js plain">,size:</code><code class="js string">'small'</code><code class="js plain">};</code></div><div class="line number2 index1 alt1"><code class="js plain">TankModel.create(tank);</code></div></div></td></tr></tbody></table></div>
</div>

<p><strong>注意：</strong></p>

<p>　　你可以使用<code class="mdCode">Model</code>来创建<code class="mdCode">Entity</code>，<code class="mdCode">Entity</code>实体是一个特有<code class="mdCode">Model</code>具体对象，但是他并不具备<code class="mdCode">Model</code>的方法，只能用自己的方法。</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div><div class="line number3 index2 alt2" style="height: 18px;">3</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js comments">//通过Model创建Entity</code></div><div class="line number2 index1 alt1"><code class="js keyword">var</code> <code class="js plain">tankEntity = </code><code class="js keyword">new</code> <code class="js plain">TankModel(</code><code class="js string">'someother'</code><code class="js plain">,</code><code class="js string">'size:big'</code><code class="js plain">);</code></div><div class="line number3 index2 alt2"><code class="js plain">tankEntity.save();</code></div></div></td></tr></tbody></table></div>
</div>

<h3 id="6query">6.Query</h3>

<p>　　查询是数据库中运用最多也是最麻烦的地方，这里对<code class="mdCode">Query</code>解读的并不完善，仅仅是自己的一点领悟而已。</p>

<h4 id="61">6.1 查询的方式</h4>

<p>　　通常有2种查询方式，一种是<code class="mdCode">直接查询</code>，一种是<code class="mdCode">链式查询</code>（2种查询都是自己命名的）</p>

<h5 id="611">6.1.1 直接查询</h5>

<p>　　在查询时带有回调函数的，称之为直接查询，查询的条件往往通过<code class="mdCode">API</code>来设定，例如：</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div><div class="line number3 index2 alt2" style="height: 18px;">3</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js plain">PersonModel.findOne({</code><code class="js string">'name.last'</code><code class="js plain">:</code><code class="js string">'dragon'</code><code class="js plain">},</code><code class="js string">'some select'</code><code class="js plain">,</code><code class="js keyword">function</code><code class="js plain">(err,person){</code></div><div class="line number2 index1 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//如果err==null，则person就能取到数据</code></div><div class="line number3 index2 alt2"><code class="js plain">});</code></div></div></td></tr></tbody></table></div>
</div>

<p>　　具体的查询参数，请查询<code class="mdCode">API</code></p>

<h5 id="612">6.1.2 链式查询</h5>

<p>　　在查询时候，不带回调，而查询条件通过<code class="mdCode">API</code>函数来制定，例如：</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div><div class="line number3 index2 alt2" style="height: 18px;">3</div><div class="line number4 index3 alt1" style="height: 18px;">4</div><div class="line number5 index4 alt2" style="height: 18px;">5</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">var</code> <code class="js plain">query = PersonModel.findOne({</code><code class="js string">'name.last'</code><code class="js plain">:</code><code class="js string">'dragon'</code><code class="js plain">});</code></div><div class="line number2 index1 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">query.select(</code><code class="js string">'some select'</code><code class="js plain">);</code></div><div class="line number3 index2 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">query.exec(</code><code class="js keyword">function</code><code class="js plain">(err,pserson){</code></div><div class="line number4 index3 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//如果err==null，则person就能取到数据</code></div><div class="line number5 index4 alt2"><code class="js plain">});</code></div></div></td></tr></tbody></table></div>
</div>

<p>　　这种方式相对直接查询，分的比较明细，如果不带<code class="mdCode">callback</code>，则返回<code class="mdCode">query</code>，<code class="mdCode">query</code>没有执行的预编译查询语句，该<code class="mdCode">query</code>对象执行的方法都将返回自己，只有在执行<code class="mdCode">exec</code>方法时才执行查询，而且必须有回调。</p>

<p>　　因为<code class="mdCode">query</code>的操作始终返回自身，我们可以采用更形象的链式写法</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div><div class="line number3 index2 alt2" style="height: 18px;">3</div><div class="line number4 index3 alt1" style="height: 18px;">4</div><div class="line number5 index4 alt2" style="height: 18px;">5</div><div class="line number6 index5 alt1" style="height: 18px;">6</div><div class="line number7 index6 alt2" style="height: 18px;">7</div><div class="line number8 index7 alt1" style="height: 18px;">8</div><div class="line number9 index8 alt2" style="height: 18px;">9</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js plain">Person</code></div><div class="line number2 index1 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">.find({ occupation: /host/ })</code></div><div class="line number3 index2 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">.where(</code><code class="js string">'name.last'</code><code class="js plain">).equals(</code><code class="js string">'Ghost'</code><code class="js plain">)</code></div><div class="line number4 index3 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">.where(</code><code class="js string">'age'</code><code class="js plain">).gt(17).lt(66)</code></div><div class="line number5 index4 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">.where(</code><code class="js string">'likes'</code><code class="js plain">).</code><code class="js keyword">in</code><code class="js plain">([</code><code class="js string">'vaporizing'</code><code class="js plain">, </code><code class="js string">'talking'</code><code class="js plain">])</code></div><div class="line number6 index5 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">.limit(10)</code></div><div class="line number7 index6 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">.sort(</code><code class="js string">'-occupation'</code><code class="js plain">)</code></div><div class="line number8 index7 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">.select(</code><code class="js string">'name occupation'</code><code class="js plain">)</code></div><div class="line number9 index8 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">.exec(callback);</code></div></div></td></tr></tbody></table></div>
</div>

<h3 id="7validation">7.Validation</h3>

<p>　　数据的存储是需要验证的，不是什么数据都能往数据库里丢或者显示到客户端的，数据的验证需要记住以下规则：</p>

<ul>
<li>验证始终定义在<code class="mdCode">SchemaType</code>中</li>
<li>验证是一个内部中间件</li>
<li>验证是在一个<code class="mdCode">Document</code>被保存时默认启用的，除非你关闭验证</li>
<li>验证是异步递归的，如果你的<code class="mdCode">SubDoc</code>验证失败，<code class="mdCode">Document</code>也将无法保存</li>
<li>验证并不关心错误类型，而通过<code class="mdCode">ValidationError</code>这个对象可以访问</li>
</ul>

<h4 id="71">7.1 验证器</h4>

<ol>
<li><code class="mdCode">required</code> 非空验证</li>
<li><code class="mdCode">min</code>/<code class="mdCode">max</code> 范围验证（边值验证）</li>
<li><code class="mdCode">enum</code>/<code class="mdCode">match</code> 枚举验证/匹配验证</li>
<li><p><code class="mdCode">validate</code> 自定义验证规则</p>

<p>　　以下是综合案例：</p></li>
</ol>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div><div class="line number3 index2 alt2" style="height: 18px;">3</div><div class="line number4 index3 alt1" style="height: 18px;">4</div><div class="line number5 index4 alt2" style="height: 18px;">5</div><div class="line number6 index5 alt1" style="height: 18px;">6</div><div class="line number7 index6 alt2" style="height: 18px;">7</div><div class="line number8 index7 alt1" style="height: 18px;">8</div><div class="line number9 index8 alt2" style="height: 18px;">9</div><div class="line number10 index9 alt1" style="height: 18px;">10</div><div class="line number11 index10 alt2" style="height: 18px;">11</div><div class="line number12 index11 alt1" style="height: 18px;">12</div><div class="line number13 index12 alt2" style="height: 18px;">13</div><div class="line number14 index13 alt1" style="height: 18px;">14</div><div class="line number15 index14 alt2" style="height: 18px;">15</div><div class="line number16 index15 alt1" style="height: 18px;">16</div><div class="line number17 index16 alt2" style="height: 18px;">17</div><div class="line number18 index17 alt1" style="height: 18px;">18</div><div class="line number19 index18 alt2" style="height: 18px;">19</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">var</code> <code class="js plain">PersonSchema = </code><code class="js keyword">new</code> <code class="js plain">Schema({</code></div><div class="line number2 index1 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">name:{</code></div><div class="line number3 index2 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">type:</code><code class="js string">'String'</code><code class="js plain">,</code></div><div class="line number4 index3 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">required:</code><code class="js keyword">true</code> <code class="js comments">//姓名非空</code></div><div class="line number5 index4 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">},</code></div><div class="line number6 index5 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">age:{</code></div><div class="line number7 index6 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">type:</code><code class="js string">'Nunmer'</code><code class="js plain">,</code></div><div class="line number8 index7 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">min:18,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="js comments">//年龄最小18</code></div><div class="line number9 index8 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">max:120&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="js comments">//年龄最大120</code></div><div class="line number10 index9 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">},</code></div><div class="line number11 index10 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">city:{</code></div><div class="line number12 index11 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">type:</code><code class="js string">'String'</code><code class="js plain">,</code></div><div class="line number13 index12 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">enum:[</code><code class="js string">'北京'</code><code class="js plain">,</code><code class="js string">'上海'</code><code class="js plain">]&nbsp; </code><code class="js comments">//只能是北京、上海人</code></div><div class="line number14 index13 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">},</code></div><div class="line number15 index14 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">other:{</code></div><div class="line number16 index15 alt1"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">type:</code><code class="js string">'String'</code><code class="js plain">,</code></div><div class="line number17 index16 alt2"><code class="js spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="js plain">validate:[validator,err]&nbsp; </code><code class="js comments">//validator是一个验证函数，err是验证失败的错误信息</code></div><div class="line number18 index17 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">}</code></div><div class="line number19 index18 alt2"><code class="js plain">});</code></div></div></td></tr></tbody></table></div>
</div>

<h4 id="72">7.2 验证失败</h4>

<p>　　如果验证失败，则会返回<code class="mdCode">err</code>信息，<code class="mdCode">err</code>是一个对象该对象属性如下</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div><div class="line number3 index2 alt2" style="height: 18px;">3</div><div class="line number4 index3 alt1" style="height: 18px;">4</div><div class="line number5 index4 alt2" style="height: 18px;">5</div><div class="line number6 index5 alt1" style="height: 18px;">6</div><div class="line number7 index6 alt2" style="height: 18px;">7</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js plain">err.errors&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="js comments">//错误集合（对象）</code></div><div class="line number2 index1 alt1"><code class="js plain">err.errors.color&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="js comments">//错误属性(Schema的color属性)</code></div><div class="line number3 index2 alt2"><code class="js plain">err.errors.color.message&nbsp; </code><code class="js comments">//错误属性信息</code></div><div class="line number4 index3 alt1"><code class="js plain">err.errors.path&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="js comments">//错误属性路径</code></div><div class="line number5 index4 alt2"><code class="js plain">err.errors.type&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="js comments">//错误类型</code></div><div class="line number6 index5 alt1"><code class="js plain">err.name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="js comments">//错误名称</code></div><div class="line number7 index6 alt2"><code class="js plain">err.message&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="js comments">//错误消息</code></div></div></td></tr></tbody></table></div>
</div>
<p>　　一旦验证失败，<code class="mdCode">Model</code>和<code class="mdCode">Entity</code>都将具有和<code class="mdCode">err</code>一样的<code class="mdCode">errors</code>属性</p>

<h3 id="8middleware">8.Middleware中间件</h3>

<h4 id="81">8.1 什么是中间件</h4>

<p>　　中间件是一种控制函数，类似插件，能控制流程中的<code class="mdCode">init</code>、validate<code class="mdCode">、</code>save<code class="mdCode">、</code>remove`方法</p>

<h4 id="82">8.2 中间件的分类</h4>

<p>　　中间件分为两类</p>

<h5 id="821serial">8.2.1 Serial串行</h5>

<p>　　串行使用<code class="mdCode">pre</code>方法，执行下一个方法使用<code class="mdCode">next</code>调用</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div><div class="line number3 index2 alt2" style="height: 18px;">3</div><div class="line number4 index3 alt1" style="height: 18px;">4</div><div class="line number5 index4 alt2" style="height: 18px;">5</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">var</code> <code class="js plain">schema = </code><code class="js keyword">new</code> <code class="js plain">Schema(...);</code></div><div class="line number2 index1 alt1"><code class="js plain">schema.pre(</code><code class="js string">'save'</code><code class="js plain">,</code><code class="js keyword">function</code><code class="js plain">(next){</code></div><div class="line number3 index2 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//做点什么</code></div><div class="line number4 index3 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">next();</code></div><div class="line number5 index4 alt2"><code class="js plain">});</code></div></div></td></tr></tbody></table></div>
</div>

<h5 id="822parallel">8.2.2 Parallel并行</h5>

<p>　　并行提供更细粒度的操作</p>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div><div class="line number3 index2 alt2" style="height: 18px;">3</div><div class="line number4 index3 alt1" style="height: 18px;">4</div><div class="line number5 index4 alt2" style="height: 18px;">5</div><div class="line number6 index5 alt1" style="height: 18px;">6</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js keyword">var</code> <code class="js plain">schema = </code><code class="js keyword">new</code> <code class="js plain">Schema(...);</code></div><div class="line number2 index1 alt1"><code class="js plain">schema.pre(</code><code class="js string">'save'</code><code class="js plain">,</code><code class="js keyword">function</code><code class="js plain">(next,done){</code></div><div class="line number3 index2 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js comments">//下一个要执行的中间件并行执行</code></div><div class="line number4 index3 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">next();</code></div><div class="line number5 index4 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">doAsync(done);</code></div><div class="line number6 index5 alt1"><code class="js plain">});</code></div></div></td></tr></tbody></table></div>
</div>

<h4 id="83">8.3 中间件特点</h4>

<p>　　一旦定义了中间件，就会在全部中间件执行完后执行其他操作，使用中间件可以雾化模型，避免异步操作的层层迭代嵌套</p>

<h4 id="84">8.4 使用范畴</h4>

<ol>
<li>复杂的验证</li>
<li>删除有主外关联的<code class="mdCode">doc</code></li>
<li>异步默认</li>
<li><p>某个特定动作触发异步任务，例如触发自定义事件和通知</p>

<p>　　例如，可以用来做自定义错误处理</p></li>
</ol>

<div data-role="collapsible" data-collapsed="false" data-theme="b" data-content-theme="a" class="mdPre">
<h1>JS</h1>
<div class="syntaxhighlighter  js"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2" style="height: 18px;">1</div><div class="line number2 index1 alt1" style="height: 18px;">2</div><div class="line number3 index2 alt2" style="height: 18px;">3</div><div class="line number4 index3 alt1" style="height: 18px;">4</div><div class="line number5 index4 alt2" style="height: 18px;">5</div><div class="line number6 index5 alt1" style="height: 18px;">6</div><div class="line number7 index6 alt2" style="height: 18px;">7</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="js plain">schema.pre(</code><code class="js string">'save'</code><code class="js plain">,</code><code class="js keyword">function</code><code class="js plain">(next){</code></div><div class="line number2 index1 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js keyword">var</code> <code class="js plain">err = </code><code class="js keyword">new</code> <code class="js plain">Eerror(</code><code class="js string">'some err'</code><code class="js plain">);</code></div><div class="line number3 index2 alt2"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">next(err);</code></div><div class="line number4 index3 alt1"><code class="js plain">});</code></div><div class="line number5 index4 alt2"><code class="js plain">entity.save(</code><code class="js keyword">function</code><code class="js plain">(err){</code></div><div class="line number6 index5 alt1"><code class="js spaces">&nbsp;&nbsp;</code><code class="js plain">console.log(err.message); </code><code class="js comments">//some err</code></div><div class="line number7 index6 alt2"><code class="js plain">});</code></div></div></td></tr></tbody></table></div>
</div>

      </div>

      <div data-role="footer" data-position="fixed" style="text-align:center;">
        <p>使用<a href="http://pages.github.com">GitHub Pages</a>构建</p>
      </div>

    </div>
  </body>
</html>
